<!DOCTYPE html>
<html lang="en">
<html>

<head>
    <title>Send From Duck | Send emails FROM your duck addresses</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./styles/style.css">
    <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
    <meta charset="UTF-8">
</head>

<body>
    <div class="container">
        <h1>Send From Duck ðŸ¦†</h1>
        <h2><i>Send emails from your duck addresses</i></h2>
        <h3>Did you know that you can send FROM duck addresses? Use this tool to help you do it!</h3>

        <div style="display: flex; flex-direction: column;">
            <label for="textbox1">Address/es to send TO (one per line):</label>
            <textarea id="textbox1" name="textbox1" placeholder="john@example.com" rows="1"></textarea>
            <label for="textbox2">Address to send FROM:</label>
            <div style="display: flex; flex-direction: row; align-items: center;">
                <div
                    style="display: flex; flex-direction: row; align-items: center; flex: 1; justify-content: flex-end;">
                    <input type="email" id="textbox2" name="textbox2" placeholder="samantha@duck.com"
                        style="flex-grow: 1;">
                    <button onclick="openPopup()"
                        style="margin-left: auto; margin-top: -35px; padding: 5px 5px; height: 30px; background-color: transparent;">
                        <img src="generate_icon.png" alt="Generate address" style="height: 175%; width: auto;">
                    </button>
                </div>

                <div id="popup">
                    <div>
                        <h2>Generate Private Duck Address</h2>
                        <p>Enter your DuckDuckGo API key here. <a
                                href='https://github.com/Hamster45105/SendFromDuck/wiki/Get-DDG-API-Key'
                                target='_blank'>Click here to find out how to get it.</a></p>
                        <input type="password" id="popupInput">
                        <div>
                            <button id="generateButton" onclick="closePopup()">Generate</button>
                            <button onclick="document.getElementById('popup').style.display = 'none';">Cancel</button>
                        </div>
                    </div>
                </div>

                <div id="errorPopup">
                    <div>
                        <h2>Error</h2>
                        <p id="error-message">An error occurred</p>
                        <button onclick="closeErrorPopup()">Dismiss</button>
                    </div>
                </div>

            </div>
            <div id="loginLink" style="display: none;">
                <label>Your special login URL:</label>
                <input id="loginUrlDisplay" type="text" id="url" value="" readonly>
                <div style="display: flex; align-items: center;">
                    <p style="color: #0074cc; text-decoration: underline; cursor: pointer; margin-right: 20px;">
                        <a href="https://github.com/Hamster45105/SendFromDuck/wiki/Functions#special-login-url"
                            target='_blank'> Find out how this works</a>
                    </p>
                    <button id="copyLoginButton">Copy</button>
                </div>
            </div>

            <button onclick="combineText()">Create Address!</button>


            <div style="display: flex; flex-direction: column; align-items: center;" hidden>
                <p id="combinedText" style="font-size: 24px; font-weight: bold; margin-top: 20px; text-align: center;">
                </p>
            </div>
            <div style="display: flex; justify-content: center;">
                <button id="copyButton" onclick="copyToClipboard()"
                    style="margin-top: 20px; background-color: #007bff; color: #fff; border: none; border-radius: 5px; padding: 10px 20px; cursor: pointer; text-align: center;"
                    hidden>Copy to Clipboard</button>
                <button id="mailButton" onclick="sendEmail()"
                    style="margin-top: 20px; margin-left: 10px; background-color: #007bff; color: #fff; border: none; border-radius: 5px; padding: 10px 20px; cursor: pointer; text-align: center;"
                    hidden>Open in Mail</button>
            </div>
            <div id="importBanner"
                style="opacity: 0; transition: opacity 0.5s; position: fixed; bottom: 20px; right: 20px; background-color: #44c767; padding: 10px 20px; box-sizing: border-box; display: flex; justify-content: space-between; align-items: center; box-shadow: 0px 2px 15px rgba(0,0,0,0.1); border-radius: 15px;">
                <p style="margin: 0; font-size: 18px; color: #fff; font-weight: 500;">Your API key has been imported
                    successfully!</p>
            </div>
        </div>
        <script>
            let result;
            let errorTextbox;

            function combineText() {
                const textbox1 = document.getElementById("textbox1");
                const textbox2 = document.getElementById("textbox2");
                const combinedTextElement = document.getElementById("combinedText");
                const copyButton = document.getElementById("copyButton");
                const mailButton = document.getElementById("mailButton");
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                const duckEmailRegex = /^[^\s@]+@duck\.com$/;

                const lines = textbox1.value.split("\n").filter(line => line.trim() !== "");
                textbox1.value = lines.join("\n");

                if (!duckEmailRegex.test(textbox2.value)) {
                    openErrorPopup("Please enter a valid duck address!");
                    errorTextbox = "textbox2";
                    return false;
                }

                const results = lines.map((line, index) => {
                    if (!emailRegex.test(line)) {
                        openErrorPopup(`"${line}" (on line ${index + 1}) is not a valid email address`);
                        errorTextbox = "textbox1";
                        return false;
                    }
                    const [localPart, domain] = line.split("@");
                    return `${localPart}_at_${domain}_${textbox2.value}`;
                });

                result = results.join(",");
                copyButton.style.backgroundColor = "#007bff";
                copyButton.textContent = "Copy to Clipboard";

                combinedTextElement.innerHTML = lines.length === 1 ? result : result.split(",").join("\n");
                copyButton.removeAttribute("hidden");
                mailButton.removeAttribute("hidden");
                document.getElementById("loginLink").style.display = "none";
            }

            function copyToClipboard() {
                const tempElement = document.createElement("textarea");
                tempElement.value = result;
                document.body.appendChild(tempElement);
                tempElement.select();
                document.execCommand("copy");
                document.body.removeChild(tempElement);
                copyButton.style.backgroundColor = "#6fc134";
                copyButton.textContent = "Copied!";
            }

            function sendEmail() {
                window.location.href = `mailto:${result}`;
            }

            function openPopup() {
                document.getElementById("popupInput").value = localStorage.getItem("apiKey");
                document.getElementById("popup").style.display = "block";
                document.getElementById("popupInput").focus();
            }

            function openErrorPopup(errorMessage) {
                document.getElementById("combinedText").innerHTML = "";
                document.getElementById("textbox2").blur();
                document.getElementById("copyButton").setAttribute("hidden", true);
                document.getElementById("mailButton").setAttribute("hidden", true);
                document.getElementById("error-message").innerHTML = errorMessage;
                document.getElementById("errorPopup").style.display = "block";
                document.getElementById("popupInput").blur();
            }

            async function closePopup() {
                const apiKey = document.getElementById("popupInput").value;
                const button = document.getElementById("generateButton");
                button.textContent = "Generating...";
                button.disabled = true;
                button.style.backgroundColor = "#808080";

                let emailAddresses;
                const cookieValue = localStorage.getItem("loginAddress");
                const generatedKey = localStorage.getItem("loginAddressKey");

                if (cookieValue && generatedKey === apiKey) {
                    emailAddresses = cookieValue;
                    localStorage.removeItem("loginAddress");
                } else {
                    emailAddresses = await postEmailAddresses(apiKey);
                }

                const duckAddress = `${emailAddresses}@duck.com`;
                document.getElementById("textbox2").value = duckAddress;
                localStorage.setItem("apiKey", apiKey);
                button.textContent = "Generate";
                button.disabled = false;
                button.style.backgroundColor = "#007bff";
                document.getElementById("popup").style.display = "none";
                document.getElementById("loginUrlDisplay").value = `${window.location.origin}/auth.html?key=${apiKey}`;
                document.getElementById("loginLink").style.display = "block";
                document.getElementById("copyLoginButton").style.backgroundColor = "#4CAF50";
                document.getElementById("copyLoginButton").textContent = "Copy";
            }

            async function postEmailAddresses(apiKey) {
                const url = "/api/generate_address";
                const button = document.getElementById("generateButton");

                const response = await fetch(url, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ apiKey })
                });

                if (response.status === 401) {
                    openErrorPopup("Invalid DuckDuckGo API Key!");
                    button.textContent = "Generate";
                    button.disabled = false;
                    button.style.backgroundColor = "#008cba";
                    return null;
                }

                return await response.json();
            }

            function pageLoad() {
                document.getElementById("textbox1").value = "";
                document.getElementById("textbox2").value = "";

                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.get('resize') === 'true') {
                    document.getElementById("textbox1").style.resize = 'vertical';
                }
                if (urlParams.get('imported') === 'true') {
                    const importBanner = document.getElementById('importBanner');
                    importBanner.style.display = 'flex';
                    importBanner.style.opacity = '1';
                    urlParams.delete('imported');
                    window.history.replaceState({}, '', `${location.pathname}?${urlParams}`);
                    setTimeout(() => importBanner.style.opacity = '0', 10000);
                }

                const urlField = document.getElementById("loginUrlDisplay");
                const copyLoginButton = document.getElementById("copyLoginButton");

                copyLoginButton.onclick = () => {
                    urlField.select();
                    document.execCommand("copy");
                    copyLoginButton.style.backgroundColor = "#6fc134";
                    copyLoginButton.textContent = "Copied!";
                }
            }

            function closeErrorPopup() {
                document.getElementById("errorPopup").style.display = "none";
                if (document.getElementById("popup").style.display === "block") {
                    document.getElementById("popupInput").focus();
                } else {
                    document.getElementById(errorTextbox).focus();
                }
                decreaseTextAreaSize();
            }

            function increaseTextAreaSize() {
                document.getElementById("textbox1").rows += 1;
            }

            function decreaseTextAreaSize() {
                const textbox1 = document.getElementById("textbox1");
                const numRows = textbox1.rows;
                const newNumLines = textbox1.value.split("\n").length;
                if (newNumLines < numRows) {
                    textbox1.rows = newNumLines;
                }
            }

            window.addEventListener("load", pageLoad);

            document.addEventListener("keydown", function (event) {
                if (event.keyCode === 13 && !event.ctrlKey && !event.altKey && !event.shiftKey) {
                    if (document.getElementById("errorPopup").style.display === "block") {
                        event.preventDefault();
                        closeErrorPopup();
                    } else if (document.activeElement === document.getElementById("popupInput")) {
                        closePopup();
                    } else if (document.activeElement === document.getElementById("textbox2")) {
                        combineText();
                    } else if (document.activeElement === document.getElementById("textbox1")) {
                        increaseTextAreaSize();
                    }
                }
            });

            document.getElementById("textbox1").addEventListener("input", decreaseTextAreaSize);
        </script>
        <script type="text/javascript"
            src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>
        <script type="text/javascript">
            function googleTranslateElementInit() {
                new google.translate.TranslateElement({ pageLanguage: 'en' }, 'google_translate_element');
            }
        </script>
    </div>

    <footer>
        <div id="google_translate_element"></div>
        <button onclick="window.open('https://github.com/Hamster45105/SendFromDuck/wiki', '_blank')"
            style="border-radius: 55px; background-color: #ff4d4d;">HELP!</button>
        <div style="margin-top: 10px;">
            <a href="https://github.com/Hamster45105/SendFromDuck" target="_blank"><img
                    src="https://img.shields.io/github/stars/Hamster45105/SendFromDuck?style=social" alt="GitHub"></a>
            <p>Made with ðŸ’– by <a href="https://github.com/Hamster45105" target='_blank'>Hamster45105</a></p>
</body>

</html>
</body>

</html>